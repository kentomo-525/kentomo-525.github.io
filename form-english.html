<!-- form_english.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Questionnaire</title>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Noto+Sans+JP&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <!-- Form -->
    <form id="surveyForm" class="c-form">
        <div class="contact-bg">
            <div class="contact-area inner">
                <h1 class="title">Questionnaire</h1>
                <p class="contact-message">
                    Please fill out the questionnaire below.<br>
                    <span class="message-notice"><span class="essential">Required</span> fields are mandatory.</span>
                </p>
                <div class="contact-inner">
                    <!-- Error messages -->
                    <div id="errorMessages"></div>
                    <table class="contact-table">
                        <tr class="table-list">
                            <th>
                                <label for="name">Full Name<span class="essential">Required</span></label>
                            </th>
                            <td>
                                <input type="text" name="name" id="name" placeholder="e.g. John Michael Smith" class="input-area" required>
                            </td>
                        </tr>
                        <tr class="table-list">
                            <th>
                                <label for="zipcode">Zip Code<span class="essential">Required</span></label>
                            </th>
                            <td>
                                <!-- No strict format for Zip Code, just required -->
                                <input type="text" name="zipcode" id="zipcode" placeholder="e.g. 90210" class="input-area" required>
                            </td>
                        </tr>
                        <tr class="table-list">
                            <th>
                                <label for="address">Address<span class="essential">Required</span></label>
                            </th>
                            <td>
                                <input type="text" name="address" id="address" placeholder="Please enter your address" class="input-area" required>
                            </td>
                        </tr>
                        <tr class="table-list">
                            <th>
                                <label for="allergies">Allergies<span class="essential">Required</span></label>
                            </th>
                            <td>
                                <p>Please select all that apply:</p>
                                <!-- Display is English, value remains Japanese -->
                                <label><input type="checkbox" name="allergies" value="アレルギーはありません">No allergies</label><br>
                                <label><input type="checkbox" name="allergies" value="卵">Egg</label><br>
                                <label><input type="checkbox" name="allergies" value="乳">Dairy</label><br>
                                <label><input type="checkbox" name="allergies" value="小麦">Wheat</label><br>
                                <label><input type="checkbox" name="allergies" value="そば">Buckwheat</label><br>
                                <label><input type="checkbox" name="allergies" value="落花生">Peanuts</label><br>
                                <label><input type="checkbox" name="allergies" value="えび">Shrimp</label><br>
                                <label><input type="checkbox" name="allergies" value="かに">Crab</label><br>
                                <label><input type="checkbox" name="allergies" value="__other_option__" id="otherOptionCheckbox">Other</label><br>
                                <input type="text" name="otherAllergy" id="otherAllergy" placeholder="If other, please specify (in Japanese)" class="input-area" style="display:none;">
                                
                                <script>
                                    document.addEventListener('DOMContentLoaded', function() {
                                        const otherCheckbox = document.getElementById('otherOptionCheckbox');
                                        const otherAllergyField = document.getElementById('otherAllergy');
                                    
                                        function toggleOtherField() {
                                            if (otherCheckbox.checked) {
                                                otherAllergyField.style.display = 'block';
                                            } else {
                                                otherAllergyField.style.display = 'none';
                                                otherAllergyField.value = '';
                                            }
                                        }
                                    
                                        otherCheckbox.addEventListener('change', toggleOtherField);
                                        toggleOtherField();
                                    });
                                </script>
                            </td>
                        </tr>
                        <tr class="table-list">
                            <th>
                                <label for="gift">Gift Selection<span class="essential">Required</span></label>
                            </th>
                            <td>
                                <div class="gift-grid">
                                    <!-- Display in English, value in Japanese -->
                                    <div class="gift-card">
                                        <label for="giftA" class="gift-label">
                                            <input type="radio" name="gift" id="giftA" value="今治タオルセット" required>
                                            <div class="gift-content">
                                                <h3 class="gift-title">Imabari Towel Set</h3>
                                                <img src="giftA.jpg" alt="Imabari Towel Set" class="gift-image">
                                                <p class="gift-note">High-quality fluffy towels</p>
                                            </div>
                                        </label>
                                    </div>
                                    <div class="gift-card">
                                        <label for="giftB" class="gift-label">
                                            <input type="radio" name="gift" id="giftB" value="瀬戸焼セット">
                                            <div class="gift-content">
                                                <h3 class="gift-title">Seto Ware Set</h3>
                                                <img src="giftB.jpg" alt="Seto Ware Set" class="gift-image">
                                                <p class="gift-note">Traditional ceramic ware</p>
                                            </div>
                                        </label>
                                    </div>
                                    <div class="gift-card">
                                        <label for="giftC" class="gift-label">
                                            <input type="radio" name="gift" id="giftC" value="お肉のカタログギフト">
                                            <div class="gift-content">
                                                <h3 class="gift-title">Meat Catalog Gift</h3>
                                                <img src="giftC.jpg" alt="Meat Catalog Gift" class="gift-image">
                                                <p class="gift-note">Finely selected branded meats</p>
                                            </div>
                                        </label>
                                    </div>
                                    <div class="gift-card">
                                        <label for="giftD" class="gift-label">
                                            <input type="radio" name="gift" id="giftD" value="なんでもカタログギフト">
                                            <div class="gift-content">
                                                <h3 class="gift-title">General Catalog Gift</h3>
                                                <img src="giftD.jpg" alt="General Catalog Gift" class="gift-image">
                                                <p class="gift-note">Choose from a wide range of items</p>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <tr class="table-list">
                            <th>
                                <label for="note">Remarks</label>
                            </th>
                            <td>
                                <textarea name="note" id="note" placeholder="Optional free text (Japanese allowed)" class="input-area"></textarea>
                            </td>
                        </tr>
                    </table>
                    <!-- Button -->
                    <div class="button-area">
                        <button type="button" id="confirmButton" class="submit-button">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Confirmation screen -->
    <div id="confirmArea" class="confirm-area" style="display: none;">
        <div class="contact-bg">
            <div class="contact-area inner">
                <h1 class="title">Confirmation</h1>
                <p class="contact-message">
                    Are you sure you want to submit the following information?
                </p>
                <div class="contact-inner">
                    <table class="contact-table">
                        <tr class="table-list">
                            <th>Full Name</th>
                            <td id="confirmName"></td>
                        </tr>
                        <tr class="table-list">
                            <th>Zip Code</th>
                            <td id="confirmZipcode"></td>
                        </tr>
                        <tr class="table-list">
                            <th>Address</th>
                            <td id="confirmAddress"></td>
                        </tr>
                        <tr class="table-list">
                            <th>Allergies</th>
                            <td id="confirmAllergies"></td>
                        </tr>
                        <tr class="table-list">
                            <th>Gift Selection</th>
                            <td id="confirmGift"></td>
                        </tr>
                        <tr class="table-list">
                            <th>Remarks</th>
                            <td id="confirmNote"></td>
                        </tr>
                    </table>
                    <!-- Buttons -->
                    <div class="button-area">
                        <button type="button" id="backButton" class="back-button">Go back and Edit</button>
                        <button type="button" id="submitButton" class="submit-button">Submit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden form for Google Forms submission -->
    <form id="hiddenForm" action="https://docs.google.com/forms/u/0/d/e/1FAIpQLSerppuex1O3qbWv__qlUvHfYkXyzZFNf_4hT3n1MOBEuqXylw/formResponse" method="POST" target="hidden_iframe" style="display: none;">
        <!-- Keep entry values as is (Japanese) -->
        <input type="hidden" name="entry.2144289705" id="hiddenName">
        <input type="hidden" name="entry.575672970" id="hiddenZipcode">
        <input type="hidden" name="entry.823249746" id="hiddenAddress">
        <div id="hiddenAllergiesContainer"></div>
        <input type="hidden" name="entry.1146449488.other_option_response" id="hiddenOtherAllergy">
        <input type="hidden" name="entry.1079425210" id="hiddenGift">
        <input type="hidden" name="entry.1892194697" id="hiddenNote">
    </form>

    <iframe name="hidden_iframe" id="hidden_iframe" style="display: none;" onload="if(submitted){window.location='thanks.html';}"></iframe>

    <script>
        let submitted = false;

        document.getElementById('confirmButton').addEventListener('click', function() {
            document.getElementById('errorMessages').innerHTML = '';

            let name = document.getElementById('name').value.trim();
            let zipcode = document.getElementById('zipcode').value.trim();
            let address = document.getElementById('address').value.trim();
            
            let allergyElements = document.querySelectorAll('input[name="allergies"]:checked');
            let allergies = Array.from(allergyElements).map(el => el.value);
            let otherAllergy = document.getElementById('otherAllergy').value.trim();

            let gift = document.querySelector('input[name="gift"]:checked');
            let note = document.getElementById('note').value.trim();

            let errors = [];

            // Name required
            if (!name) {
                errors.push('Please enter your name.');
            }

            // Zip Code required (no format check)
            if (!zipcode) {
                errors.push('Please enter your zip code.');
            }

            // Address required
            if (!address) {
                errors.push('Please enter your address.');
            }

            // Gift required
            if (!gift) {
                errors.push('Please select a gift.');
            }

            // Allergies validation
            if (allergies.length === 0) {
                errors.push('Please select at least one allergy option.');
            } else {
                if (allergies.includes('アレルギーはありません') && allergies.length > 1) {
                    errors.push('If you select "No allergies", you cannot select other options.');
                }
                if (allergies.includes('__other_option__') && !otherAllergy) {
                    errors.push('If you selected "Other", please specify your allergy.');
                }
            }

            if (errors.length > 0) {
                let errorHTML = '';
                errors.forEach(function(error) {
                    errorHTML += '<p class="error-message">' + error + '</p>';
                });
                document.getElementById('errorMessages').innerHTML = errorHTML;
                document.getElementById('errorMessages').scrollIntoView({behavior: 'smooth'});
            } else {
                // Process other option
                if (!allergies.includes('アレルギーはありません') && allergies.includes('__other_option__')) {
                    allergies = allergies.filter(a => a !== '__other_option__');
                    if (otherAllergy) {
                        allergies.push(otherAllergy);
                    }
                } else {
                    allergies = allergies.filter(a => a !== '__other_option__');
                }

                document.getElementById('confirmName').innerText = name;
                document.getElementById('confirmZipcode').innerText = zipcode;
                document.getElementById('confirmAddress').innerText = address;
                // Display confirmed allergies (English UI, but joined values are Japanese)
                document.getElementById('confirmAllergies').innerText = (allergies.length > 0) ? allergies.join(', ') : 'None';
                // Gift is displayed in English, but value is Japanese
                document.getElementById('confirmGift').innerText = gift.value;
                document.getElementById('confirmNote').innerText = note ? note : 'None';

                document.getElementById('surveyForm').style.display = 'none';
                document.getElementById('confirmArea').style.display = 'block';
            }
        });

        document.getElementById('backButton').addEventListener('click', function() {
            document.getElementById('confirmArea').style.display = 'none';
            document.getElementById('surveyForm').style.display = 'block';
        });

        document.getElementById('submitButton').addEventListener('click', function() {
            submitted = true;

            document.getElementById('hiddenAllergiesContainer').innerHTML = '';

            document.getElementById('hiddenName').value = document.getElementById('name').value.trim();
            document.getElementById('hiddenZipcode').value = document.getElementById('zipcode').value.trim();
            document.getElementById('hiddenAddress').value = document.getElementById('address').value.trim();

            let allergyElements = document.querySelectorAll('input[name="allergies"]:checked');
            let otherAllergyValue = document.getElementById('otherAllergy').value.trim();

            let hasOther = false;
            let hasNoAllergy = false;
            allergyElements.forEach(function(el){
                if (el.value === '__other_option__') {
                    hasOther = true;
                } else if (el.value === 'アレルギーはありません') {
                    hasNoAllergy = true;
                } else {
                    let hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'entry.1146449488';
                    hiddenInput.value = el.value; // Japanese value
                    document.getElementById('hiddenAllergiesContainer').appendChild(hiddenInput);
                }
            });

            if (hasNoAllergy) {
                let noAllergyInput = document.createElement('input');
                noAllergyInput.type = 'hidden';
                noAllergyInput.name = 'entry.1146449488';
                noAllergyInput.value = 'アレルギーはありません';
                document.getElementById('hiddenAllergiesContainer').appendChild(noAllergyInput);

                document.getElementById('hiddenOtherAllergy').value = '';
            } else {
                if (hasOther) {
                    let otherOptionInput = document.createElement('input');
                    otherOptionInput.type = 'hidden';
                    otherOptionInput.name = 'entry.1146449488';
                    otherOptionInput.value = '__other_option__';
                    document.getElementById('hiddenAllergiesContainer').appendChild(otherOptionInput);

                    // User input in otherAllergyValue is presumably in Japanese as needed
                    document.getElementById('hiddenOtherAllergy').value = otherAllergyValue;
                } else {
                    document.getElementById('hiddenOtherAllergy').value = '';
                }
            }

            // Gift value in Japanese
            document.getElementById('hiddenGift').value = document.querySelector('input[name="gift"]:checked').value;
            // Note as is (could be Japanese)
            document.getElementById('hiddenNote').value = document.getElementById('note').value.trim();

            document.getElementById('hiddenForm').submit();
        });
    </script>
</body>
</html>
