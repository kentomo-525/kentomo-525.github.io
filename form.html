<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, user-scalable=yes">
    <title>アンケートフォーム</title>
    <!-- フォントやアイコンの読み込み -->
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Noto+Sans+JP&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <!-- フォーム -->
    <form id="surveyForm" class="c-form">
        <div class="contact-bg">
            <div class="contact-area inner">
                <h1 class="title">アンケート</h1>
                <p class="contact-message">
                    以下のアンケートにご協力ください<br>
                    <span class="message-notice"><span class="essential">必須</span>は必須項目です</span>
                </p>
                <div class="contact-inner">
                    <!-- エラーメッセージ表示領域 -->
                    <div id="errorMessages"></div>
                    <table class="contact-table">
                        <tr class="table-list">
                            <th><label for="name">お名前 <br class="ps-br"><span class="essential">必須</span></label></th>
                            <td><input type="text" name="name" id="name" placeholder="例: 山田 太郎" class="input-area" required></td>
                        </tr>
                        <tr class="table-list">
                            <th><label for="zipcode">郵便番号 <br class="ps-br"><span class="essential">必須</span></label></th>
                            <td><input type="text" name="zipcode" id="zipcode" placeholder="例: 123-4567" class="input-area" required></td>
                        </tr>
                        <tr class="table-list">
                            <th><label for="address">住所 <br class="ps-br"><span class="essential">必須</span></label></th>
                            <td><input type="text" name="address" id="address" placeholder="住所をご入力ください" class="input-area" required></td>
                        </tr>
                        <tr class="table-list">
                            <th><label for="tel">電話番号 <br class="ps-br"><span class="essential">必須</span></label></th>
                            <td><input type="text" name="tel" id="tel" placeholder="例: 03-1234-5678" class="input-area" required></td>
                        </tr>

                        <!-- 前泊予定（必須） -->
                        <tr class="table-list">
                            <th>前泊予定 <br class="ps-br"><span class="essential">必須</span></th>
                            <td>
                                <p class="note">現時点でのご予定で結構です<br>なお提携ホテルはありません<br>申し訳ないですが ご自身でご準備をお願いします</p>
                                <label><input type="radio" name="stay" value="あり">あり</label><br>
                                <label><input type="radio" name="stay" value="なし">なし</label>
                            </td>
                        </tr>

                        <!-- 送迎（必須） -->
                        <tr class="table-list">
                            <th>送迎 <br class="ps-br"><span class="essential">必須</span></th>
                            <td>
                                <p class="note">現時点でのご予定で結構です<br>送迎は「広島駅〜会場の往復」を想定しています</p>
                                <label><input type="radio" name="transfer" value="希望する">希望する</label><br>
                                <label><input type="radio" name="transfer" value="希望しない">希望しない</label>
                            </td>
                        </tr>

                        <!-- 引き出物選択（必須） -->
                        <tr class="table-list">
                            <th><label for="gift">引き出物選択 <br class="ps-br"><span class="essential">必須</span></label></th>
                            <td>
                                <label><input type="radio" name="gift" value="瀬戸焼セット">けんちゃん出身！愛知の瀬戸焼セット</label><br>
                                <label><input type="radio" name="gift" value="今治タオルセット">ともちゃん出身！愛媛の今治タオルセット</label><br>
                                <label><input type="radio" name="gift" value="カタログギフト">なんでもあります！カタログギフト</label><br>
                            </td>
                        </tr>

                        <!-- 代表者アレルギー -->
                        <tr class="table-list">
                            <th><label for="allergies">アレルギー(代表者) <br class="ps-br"><span class="essential">必須</span></label></th>
                            <td>
                                <p class="note">該当するものを全てお選びください:</p>
                                <label><input type="checkbox" name="allergies" value="アレルギーはありません">アレルギーはありません</label><br>
                                <label><input type="checkbox" name="allergies" value="卵">卵</label><br>
                                <label><input type="checkbox" name="allergies" value="乳">乳</label><br>
                                <label><input type="checkbox" name="allergies" value="小麦">小麦</label><br>
                                <label><input type="checkbox" name="allergies" value="そば">そば</label><br>
                                <label><input type="checkbox" name="allergies" value="落花生">落花生</label><br>
                                <label><input type="checkbox" name="allergies" value="えび">えび</label><br>
                                <label><input type="checkbox" name="allergies" value="かに">かに</label><br>
                                <label><input type="checkbox" name="allergies" value="__other_option__" id="otherOptionCheckbox">その他</label><br>
                                <input type="text" name="otherAllergy" id="otherAllergy" placeholder="その他アレルギーをご記入ください" class="input-area" style="display:none;">
                            </td>
                        </tr>
                    </table>

                    <!-- 家族情報表示領域 -->
                    <div id="familyContainer"></div>

                    <!-- 家族追加ボタン -->
                    <div class="button-area">
                        <button type="button" id="addFamilyButton" class="submit-button">家族をひとり<br class="ps-br">追加する</button>
                    </div>

                    <table class="contact-table" style="margin-top:20px; margin-bottom: 20px;">
                        <tr class="table-list">
                            <th><label for="cookingNote">料理について</label></th>
                            <td>
                                <textarea name="cookingNote" id="cookingNote" rows="5" placeholder="例: 肉はよく焼き希望 トマトは苦手です など" class="input-area"></textarea>
                            </td>
                        </tr>
                        <tr class="table-list">
                            <th><label for="note">備考</label></th>
                            <td>
                                <textarea name="note" id="note" rows="5" placeholder="妊娠・授乳中の方はお知らせください その他なんでもご記入ください" class="input-area"></textarea>
                            </td>
                        </tr>
                    </table>

                    <!-- ボタン -->
                    <div class="button-area">
                        <button type="button" id="confirmButton" class="submit-button">確認する</button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- 確認画面 -->
    <div id="confirmArea" class="confirm-area" style="display: none;">
        <div class="contact-bg">
            <div class="contact-area inner">
                <h1 class="title">内容確認</h1>
                <p class="contact-message">
                    以下の内容で送信してよろしいですか？
                </p>
                <div class="contact-inner">
                    <table class="contact-table">
                        <tr class="table-list"><th>お名前</th><td id="confirmName"></td></tr>
                        <tr class="table-list"><th>郵便番号</th><td id="confirmZipcode"></td></tr>
                        <tr class="table-list"><th>住所</th><td id="confirmAddress"></td></tr>
                        <tr class="table-list"><th>電話番号</th><td id="confirmTel"></td></tr>
                        <tr class="table-list"><th>前泊予定</th><td id="confirmStay"></td></tr>
                        <tr class="table-list"><th>送迎</th><td id="confirmTransfer"></td></tr>
                        <tr class="table-list"><th>引き出物選択</th><td id="confirmGift"></td></tr>
                        <tr class="table-list"><th>アレルギー(代表者)</th><td id="confirmAllergies"></td></tr>
                        <tr class="table-list"><th>ご家族情報</th><td id="confirmFamily"></td></tr>
                        <tr class="table-list"><th>料理について</th><td id="confirmCookingNote"></td></tr>
                        <tr class="table-list"><th>備考</th><td id="confirmNote"></td></tr>
                    </table>
                    <!-- ボタン -->
                    <div class="button-area">
                        <button type="button" id="backButton" class="back-button">戻って修正</button>
                        <button type="button" id="submitButton" class="submit-button">送信する</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- hiddenForm: Google Formへ実際に送信するフォーム -->
    <form id="hiddenForm" action="https://docs.google.com/forms/u/0/d/e/1FAIpQLSce369SUfLwfBpjhgxklR3ted6aMqrOAbOJQawPZ5eCRaz_IQ/formResponse" method="POST" target="hidden_iframe" style="display: none;">
        <input type="hidden" name="entry.921353175" id="hiddenName">
        <input type="hidden" name="entry.1797642165" id="hiddenZipcode">
        <input type="hidden" name="entry.313371845" id="hiddenAddress">
        <input type="hidden" name="entry.1295928437" id="hiddenTel">
        <input type="hidden" name="entry.348142545" id="hiddenStay">
        <input type="hidden" name="entry.168426545" id="hiddenTransfer">
        <input type="hidden" name="entry.1101638032" id="hiddenGift">
        <div id="hiddenAllergiesContainer"></div>
        <input type="hidden" name="entry.128487.other_option_response" id="hiddenOtherAllergy">

        <!-- 家族用エントリID -->
        <!-- i=1 → 名前2/アレルギー2: entry.841055094 / entry.1819568919
             i=2 → 名前3/アレルギー3: entry.553710723 / entry.1133277251
             i=3 → 名前4/アレルギー4: entry.1853209159 / entry.1459943140
             i=4 → 名前5/アレルギー5: entry.637064869 / entry.1559765652
             i=5 → 名前6/アレルギー6: entry.1364354979 / entry.99063092
        -->
        <div id="hiddenFamilyContainer"></div>

        <input type="hidden" name="entry.741354208" id="hiddenCookingNote">
        <input type="hidden" name="entry.495765740" id="hiddenNote">
    </form>

    <iframe name="hidden_iframe" id="hidden_iframe" style="display: none;" onload="if(submitted){window.location='thanks.html';}"></iframe>

    <script>
        let submitted = false;
        let familyCount = 0;
        const maxFamily = 5;

        // 家族エントリIDマッピング
        const familyNameEntries = [
            "entry.841055094", // 名前2
            "entry.553710723", // 名前3
            "entry.1853209159",// 名前4
            "entry.637064869", // 名前5
            "entry.1364354979" // 名前6
        ];
        const familyAllergyEntries = [
            "entry.1819568919", // アレルギー2
            "entry.1133277251", // アレルギー3
            "entry.1459943140", // アレルギー4
            "entry.1559765652", // アレルギー5
            "entry.99063092"    // アレルギー6
        ];

        function setupOtherAllergyField(container) {
            const otherCheckbox = container.querySelector('.otherOptionCheckbox');
            const otherAllergyInput = container.querySelector('.otherAllergyInput');
            if (!otherCheckbox || !otherAllergyInput) return;

            function toggleOtherField() {
                if (otherCheckbox.checked) {
                    otherAllergyInput.style.display = 'block';
                } else {
                    otherAllergyInput.style.display = 'none';
                    otherAllergyInput.value = '';
                }
            }
            otherCheckbox.addEventListener('change', toggleOtherField);
            toggleOtherField();
        }

        document.addEventListener('DOMContentLoaded', function() {
            const mainOtherCheckbox = document.getElementById('otherOptionCheckbox');
            const mainOtherAllergyField = document.getElementById('otherAllergy');

            // 代表者その他アレルギー表示制御
            function toggleMainOtherField() {
                if (mainOtherCheckbox && mainOtherCheckbox.checked) {
                    mainOtherAllergyField.style.display = 'block';
                } else {
                    mainOtherAllergyField.style.display = 'none';
                    mainOtherAllergyField.value = '';
                }
            }
            if (mainOtherCheckbox) {
                mainOtherCheckbox.addEventListener('change', toggleMainOtherField);
                toggleMainOtherField();
            }

            document.getElementById('addFamilyButton').addEventListener('click', function(){
                if (familyCount >= maxFamily) {
                    alert('追加できる家族は最大' + maxFamily + '名までです ');
                    return;
                }
                familyCount++;
                const familyContainer = document.getElementById('familyContainer');

                const wrapper = document.createElement('div');
                // wrapper.style.marginTop = '20px';

                const hr = document.createElement('hr');
                wrapper.appendChild(hr);

                // 名前フィールド
                const nameRow = document.createElement('table');
                nameRow.classList.add('contact-table');
                const nameTr = document.createElement('tr');
                nameTr.classList.add('table-list');
                const nameTh = document.createElement('th');
                const nameTd = document.createElement('td');

                const nameLabel = document.createElement('label');
                nameLabel.setAttribute('for', 'nameFam' + familyCount);
                nameLabel.innerText = 'お名前';

                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.name = 'nameFam' + familyCount;
                nameInput.id = 'nameFam' + familyCount;
                nameInput.classList.add('input-area');
                nameInput.placeholder = 'ご家族追加' + familyCount + '人目のお名前（任意）';

                nameTh.appendChild(nameLabel);
                nameTd.appendChild(nameInput);
                nameTr.appendChild(nameTh);
                nameTr.appendChild(nameTd);
                nameRow.appendChild(nameTr);

                wrapper.appendChild(nameRow);

                // アレルギーフィールド
                const allergyRow = document.createElement('table');
                allergyRow.classList.add('contact-table');
                const allergyTr = document.createElement('tr');
                allergyTr.classList.add('table-list');
                const allergyTh = document.createElement('th');
                const allergyTd = document.createElement('td');
                allergyTh.innerText = 'アレルギー';

                const p = document.createElement('p');
                p.innerText = '該当するものを全てお選びください:';
                allergyTd.appendChild(p);

                const allergies = ["アレルギーはありません","卵","乳","小麦","そば","落花生","えび","かに","__other_option__"];
                allergies.forEach(val => {
                    const label = document.createElement('label');
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.name = 'allergiesFam' + familyCount;
                    cb.value = val;
                    label.appendChild(cb);

                    if (val === "__other_option__") {
                        label.appendChild(document.createTextNode('その他'));
                        cb.classList.add('otherOptionCheckbox');
                    } else {
                        label.appendChild(document.createTextNode(val));
                    }
                    allergyTd.appendChild(label);
                    allergyTd.appendChild(document.createElement('br'));
                });

                const otherAllergyInput = document.createElement('input');
                otherAllergyInput.type = 'text';
                otherAllergyInput.name = 'otherAllergyFam' + familyCount;
                otherAllergyInput.classList.add('input-area');
                otherAllergyInput.classList.add('otherAllergyInput');
                otherAllergyInput.placeholder = 'その他アレルギーをご記入ください';
                otherAllergyInput.style.display = 'none';

                allergyTd.appendChild(otherAllergyInput);
                allergyTr.appendChild(allergyTh);
                allergyTr.appendChild(allergyTd);
                allergyRow.appendChild(allergyTr);

                wrapper.appendChild(allergyRow);

                familyContainer.appendChild(wrapper);

                // セットアップ
                setupOtherAllergyField(wrapper);
            });

            document.getElementById('confirmButton').addEventListener('click', function() {
                document.getElementById('errorMessages').innerHTML = '';

                let name = document.getElementById('name').value.trim();
                let zipcode = document.getElementById('zipcode').value.trim();
                let address = document.getElementById('address').value.trim();
                let tel = document.getElementById('tel').value.trim();

                let stay = document.querySelector('input[name="stay"]:checked');
                let transfer = document.querySelector('input[name="transfer"]:checked');
                let gift = document.querySelector('input[name="gift"]:checked');
                let note = document.getElementById('note').value.trim();
                let cookingNote = document.getElementById('cookingNote').value.trim();

                // 代表者アレルギー
                let allergyElements = document.querySelectorAll('input[name="allergies"]:checked');
                let allergies = Array.from(allergyElements).map(el => el.value);
                let otherAllergy = document.getElementById('otherAllergy').value.trim();

                let errors = [];

                // 必須チェック
                if (!name) errors.push('お名前を入力してください ');
                if (!zipcode) errors.push('郵便番号を入力してください ');
                if (!address) errors.push('住所を入力してください ');
                if (!tel) errors.push('電話番号を入力してください ');
                if (!stay) errors.push('前泊予定を選択してください ');
                if (!transfer) errors.push('送迎を選択してください ');
                if (!gift) errors.push('引き出物を選択してください ');

                // 代表者アレルギーチェック
                if (allergies.length === 0) {
                    errors.push('代表者のアレルギーについて いずれかを選択してください ');
                } else {
                    if (allergies.includes('アレルギーはありません') && allergies.length > 1) {
                        errors.push('（代表者）「アレルギーはありません」を選択した場合 他のアレルギーは選択できません ');
                    }
                    if (allergies.includes('__other_option__') && !otherAllergy) {
                        errors.push('（代表者）「その他」を選択した場合は その他アレルギー内容を入力してください ');
                    }
                }

                // 家族情報チェック
                let familyData = [];
                for (let i = 1; i <= familyCount; i++) {
                    let fname = document.getElementById('nameFam' + i)?.value.trim() || '';
                    let fallergyEls = document.querySelectorAll('input[name="allergiesFam' + i + '"]:checked');
                    let fallergies = Array.from(fallergyEls).map(el => el.value);
                    let fotherAllergy = document.querySelector('input[name="otherAllergyFam' + i + '"]')?.value.trim() || '';

                    // 名前がある場合はアレルギー必須
                    if (fname) {
                        if (fallergies.length === 0) {
                            errors.push('ご家族' + i + '人目のお名前が入力されていますが アレルギーが未選択です ');
                        } else {
                            if (fallergies.includes('アレルギーはありません') && fallergies.length > 1) {
                                errors.push('ご家族' + i + '人目：「アレルギーはありません」を選択した場合 他のアレルギーは選択できません ');
                            }
                            if (fallergies.includes('__other_option__') && !fotherAllergy) {
                                errors.push('ご家族' + i + '人目：「その他」を選択した場合は その他アレルギー内容を入力してください ');
                            }
                        }
                    }

                    // ここでは「__other_option__」は削除せず残しておく
                    // Googleフォームで「その他」オプションを認識させるため 
                    // 送信時に__other_option__を送信し かつ other_option_responseを送るようにする 
                    familyData.push({
                        name: fname,
                        allergies: fallergies,
                        otherAllergy: fotherAllergy
                    });
                }

                if (errors.length > 0) {
                    let errorHTML = '';
                    errors.forEach(function(error) {
                        errorHTML += '<p class="error-message">' + error + '</p>';
                    });
                    document.getElementById('errorMessages').innerHTML = errorHTML;
                    document.getElementById('errorMessages').scrollIntoView({behavior: 'smooth'});
                } else {
                    // 代表者その他オプション処理
                    // __other_option__は残して 入力値をother_option_responseにセット
                    // すでに確認画面には代入済みなので省略

                    // 確認画面反映
                    document.getElementById('confirmName').innerText = name;
                    document.getElementById('confirmZipcode').innerText = zipcode;
                    document.getElementById('confirmAddress').innerText = address;
                    document.getElementById('confirmTel').innerText = tel;
                    document.getElementById('confirmStay').innerText = stay ? stay.value : '未選択';
                    document.getElementById('confirmTransfer').innerText = transfer ? transfer.value : '未選択';
                    if (!allergies.includes('アレルギーはありません') && allergies.includes('__other_option__') && otherAllergy) {
                        // 表示用に__other_option__を実際の文字列に置き換え
                        let displayAllergies = allergies.map(a => a === '__other_option__' ? otherAllergy : a);
                        document.getElementById('confirmAllergies').innerText = displayAllergies.join(' ');
                    } else {
                        document.getElementById('confirmAllergies').innerText = (allergies.length > 0) ? allergies.join(' ') : 'なし';
                    }
                    document.getElementById('confirmGift').innerText = gift ? gift.value : '未選択';
                    document.getElementById('confirmCookingNote').innerText = cookingNote || 'なし';
                    document.getElementById('confirmNote').innerText = note ? note : 'なし';

                    let familyHTML = '';
                    familyData.forEach((f, idx) => {
                        if (f.name || f.allergies.length > 0) {
                            let displayAllergies = f.allergies.slice();
                            // 家族のその他対応：表示時は__other_option__をテキストに置換
                            if (!displayAllergies.includes('アレルギーはありません') && displayAllergies.includes('__other_option__') && f.otherAllergy) {
                                displayAllergies = displayAllergies.map(a => a === '__other_option__' ? f.otherAllergy : a);
                            }
                            familyHTML += '<p><strong>家族' + (idx+1) + ':</strong> ' + (f.name || '（名称未入力）') + '<br>アレルギー: ' + (displayAllergies.length > 0 ? displayAllergies.join(' ') : 'なし') + '</p>';
                        }
                    });
                    if (!familyHTML) familyHTML = 'なし';
                    document.getElementById('confirmFamily').innerHTML = familyHTML;

                    document.getElementById('surveyForm').style.display = 'none';
                    document.getElementById('confirmArea').style.display = 'block';
                }
            });

            document.getElementById('backButton').addEventListener('click', function() {
                document.getElementById('confirmArea').style.display = 'none';
                document.getElementById('surveyForm').style.display = 'block';
            });

            document.getElementById('submitButton').addEventListener('click', function() {
                submitted = true;

                // 送信前にhiddenAllergiesContainerとhiddenFamilyContainerをクリア
                document.getElementById('hiddenAllergiesContainer').innerHTML = '';
                document.getElementById('hiddenFamilyContainer').innerHTML = '';

                document.getElementById('hiddenName').value = document.getElementById('name').value.trim();
                document.getElementById('hiddenZipcode').value = document.getElementById('zipcode').value.trim();
                document.getElementById('hiddenAddress').value = document.getElementById('address').value.trim();
                document.getElementById('hiddenTel').value = document.getElementById('tel').value.trim();

                let stay = document.querySelector('input[name="stay"]:checked');
                document.getElementById('hiddenStay').value = stay ? stay.value : '';
                let transfer = document.querySelector('input[name="transfer"]:checked');
                document.getElementById('hiddenTransfer').value = transfer ? transfer.value : '';

                let gift = document.querySelector('input[name="gift"]:checked');
                document.getElementById('hiddenGift').value = gift ? gift.value : '';

                document.getElementById('hiddenNote').value = document.getElementById('note').value.trim();
                document.getElementById('hiddenCookingNote').value = document.getElementById('cookingNote').value.trim();

                let allergyElements = document.querySelectorAll('input[name="allergies"]:checked');
                let otherAllergyValue = document.getElementById('otherAllergy').value.trim();
                let hasOther = false;
                let hasNoAllergy = false;
                allergyElements.forEach(function(el){
                    if (el.value === '__other_option__') {
                        hasOther = true;
                    } else if (el.value === 'アレルギーはありません') {
                        hasNoAllergy = true;
                    } else {
                        let fallergyInput = document.createElement('input');
                        fallergyInput.type = 'hidden';
                        fallergyInput.name = 'entry.128487';
                        fallergyInput.value = el.value;
                        document.getElementById('hiddenAllergiesContainer').appendChild(fallergyInput);
                    }
                });

                if (hasNoAllergy) {
                    let noAllergyInput = document.createElement('input');
                    noAllergyInput.type = 'hidden';
                    noAllergyInput.name = 'entry.128487';
                    noAllergyInput.value = 'アレルギーはありません';
                    document.getElementById('hiddenAllergiesContainer').appendChild(noAllergyInput);

                    document.getElementById('hiddenOtherAllergy').value = '';
                } else {
                    if (hasOther) {
                        // メイン「その他」選択時は__other_option__を回答として送信
                        let otherOptionInput = document.createElement('input');
                        otherOptionInput.type = 'hidden';
                        otherOptionInput.name = 'entry.128487';
                        otherOptionInput.value = '__other_option__';
                        document.getElementById('hiddenAllergiesContainer').appendChild(otherOptionInput);

                        document.getElementById('hiddenOtherAllergy').value = otherAllergyValue;
                    } else {
                        document.getElementById('hiddenOtherAllergy').value = '';
                    }
                }

                // 家族分の処理
                for (let i = 1; i <= familyCount; i++) {
                    let fname = document.getElementById('nameFam' + i)?.value.trim() || '';
                    let fallergyEls = document.querySelectorAll('input[name="allergiesFam' + i + '"]:checked');
                    let fallergies = Array.from(fallergyEls).map(el => el.value);
                    let fotherAllergy = document.querySelector('input[name="otherAllergyFam' + i + '"]')?.value.trim() || '';

                    if (i <= 5) {
                        let nameEntry = familyNameEntries[i-1];
                        let allergyEntry = familyAllergyEntries[i-1];
                        if (fname || fallergies.length > 0) {
                            // 家族名
                            let nameInput = document.createElement('input');
                            nameInput.type = 'hidden';
                            nameInput.name = nameEntry;
                            nameInput.value = fname;
                            document.getElementById('hiddenFamilyContainer').appendChild(nameInput);

                            // 家族アレルギー
                            let hasFamilyOther = false;
                            fallergies.forEach(fa => {
                                if (fa === '__other_option__') {
                                    hasFamilyOther = true;
                                } else if (fa !== 'アレルギーはありません') {
                                    let fallergyInput = document.createElement('input');
                                    fallergyInput.type = 'hidden';
                                    fallergyInput.name = allergyEntry;
                                    fallergyInput.value = fa;
                                    document.getElementById('hiddenFamilyContainer').appendChild(fallergyInput);
                                } else if (fa === 'アレルギーはありません') {
                                    let noAllergyInputFam = document.createElement('input');
                                    noAllergyInputFam.type = 'hidden';
                                    noAllergyInputFam.name = allergyEntry;
                                    noAllergyInputFam.value = 'アレルギーはありません';
                                    document.getElementById('hiddenFamilyContainer').appendChild(noAllergyInputFam);
                                }
                            });

                            // その他対応
                            if (hasFamilyOther) {
                                // __other_option__を送信
                                let otherFamOptionInput = document.createElement('input');
                                otherFamOptionInput.type = 'hidden';
                                otherFamOptionInput.name = allergyEntry;
                                otherFamOptionInput.value = '__other_option__';
                                document.getElementById('hiddenFamilyContainer').appendChild(otherFamOptionInput);

                                // other_option_responseへテキストを送信
                                let otherFamResponseInput = document.createElement('input');
                                otherFamResponseInput.type = 'hidden';
                                otherFamResponseInput.name = allergyEntry + '.other_option_response';
                                otherFamResponseInput.value = fotherAllergy;
                                document.getElementById('hiddenFamilyContainer').appendChild(otherFamResponseInput);
                            }
                        }
                    }
                }

                document.getElementById('hiddenForm').submit();
            });
        });

    </script>
</body>
</html>
